<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>Zip 파일 반환하는 ActionResult 만들기 &#8211; 제이키의 MVC 이야기</title>
<meta name="description" content="이미지 뷰어를 구현하다 다운로드 기능이 필요해졌다. 한 번 클릭에 뷰어에서 재생되는 모든 이미지를 압축하여 다운로드 한다. 아무래도 압축 풀기의 번거로움이 있으니 이미지가 하나만 있다면 압축 없이 다운로드할 수 있게 해보자.

">
<meta name="keywords" content="mvc">


<!-- Twitter Cards -->
<meta name="twitter:title" content="Zip 파일 반환하는 ActionResult 만들기">
<meta name="twitter:description" content="이미지 뷰어를 구현하다 다운로드 기능이 필요해졌다. 한 번 클릭에 뷰어에서 재생되는 모든 이미지를 압축하여 다운로드 한다. 아무래도 압축 풀기의 번거로움이 있으니 이미지가 하나만 있다면 압축 없이 다운로드할 수 있게 해보자.

">



<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://blog.jakeymvc.com/images/site-logo.gif">

<!-- Open Graph -->
<meta property="og:locale" content="kr_KR">
<meta property="og:type" content="article">
<meta property="og:title" content="Zip 파일 반환하는 ActionResult 만들기">
<meta property="og:description" content="이미지 뷰어를 구현하다 다운로드 기능이 필요해졌다. 한 번 클릭에 뷰어에서 재생되는 모든 이미지를 압축하여 다운로드 한다. 아무래도 압축 풀기의 번거로움이 있으니 이미지가 하나만 있다면 압축 없이 다운로드할 수 있게 해보자.

">
<meta property="og:url" content="http://blog.jakeymvc.com/action-result-to-return-zip-file/">
<meta property="og:site_name" content="제이키의 MVC 이야기">





<link rel="canonical" href="http://blog.jakeymvc.com/action-result-to-return-zip-file/">
<link href="http://blog.jakeymvc.com/feed.xml" type="application/atom+xml" rel="alternate" title="제이키의 MVC 이야기 Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- For all browsers -->
<link rel="stylesheet" href="http://blog.jakeymvc.com/assets/css/main.css">
<!-- Webfonts -->
<script src="https://use.edgefonts.net/source-sans-pro:n2,i2,n3,i3,n4,i4,n6,i6,n7,i7,n9,i9;source-code-pro:n4,n7;volkhov.js"></script>

<meta http-equiv="cleartype" content="on">

<!-- HTML5 Shiv and Media Query Support -->
<!--[if lt IE 9]>
  <script src="http://blog.jakeymvc.com/assets/js/vendor/html5shiv.min.js"></script>
  <script src="http://blog.jakeymvc.com/assets/js/vendor/respond.min.js"></script>
<![endif]-->

<!-- Modernizr -->
<script src="http://blog.jakeymvc.com/assets/js/vendor/modernizr-2.7.1.custom.min.js"></script>


<!-- MathJax -->
<script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>


<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="http://blog.jakeymvc.com/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="http://blog.jakeymvc.com/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="http://blog.jakeymvc.com/images/apple-touch-icon-precomposed.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="http://blog.jakeymvc.com/images/apple-touch-icon-72x72-precomposed.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="http://blog.jakeymvc.com/images/apple-touch-icon-114x114-precomposed.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://blog.jakeymvc.com/images/apple-touch-icon-144x144-precomposed.png">


</head>

<body id="post">
<div class="navigation-wrapper">
	<nav role="navigation" id="site-nav" class="animated drop">
	    <ul>
      
		    
		    <li><a href="http://blog.jakeymvc.com/about/" >About</a></li>
		  
		    
		    <li><a href="http://blog.jakeymvc.com/articles/" >Articles</a></li>
		  
		    
		    <li><a href="http://blog.jakeymvc.com/blog/" >Blog</a></li>
		  
		    
		    <li><a href="http://blog.jakeymvc.com/tags/" >Tags</a></li>
		  
		    
		    <li><a href="http://blog.jakeymvc.com/search/" >Search</a></li>
		  
	    </ul>
	</nav>
</div><!-- /.navigation-wrapper -->

<!--[if lt IE 9]><div class="upgrade"><strong><a href="http://whatbrowser.org/">Your browser is quite old!</strong> Why not upgrade to a different browser to better enjoy this site?</a></div><![endif]-->

<header class="masthead">
	<div class="wrap">
      
  		<a href="http://blog.jakeymvc.com/" class="site-logo" rel="home" title="제이키의 MVC 이야기"><img src="http://blog.jakeymvc.com/images/site-logo.gif" width="200" height="200" alt="제이키의 MVC 이야기 logo" class="animated fadeInDown"></a>
      
      <h1 class="site-title animated fadeIn"><a href="http://blog.jakeymvc.com/">제이키의 MVC 이야기</a></h1>
		<h2 class="site-description animated fadeIn" itemprop="description">웹 개발은 MVC 패턴으로. Angular와 ASP.NET Core의 궁합은?</h2>
	</div>
</header><!-- /.masthead -->

<div class="js-menu-screen menu-screen"></div>


<div id="main" role="main">
  <article class="hentry">
    
    <div class="entry-wrapper">
      <header class="entry-header">
        <ul class="entry-tags">
          <li><a href="http://blog.jakeymvc.com/tags/#mvc" title="Pages tagged mvc">mvc</a></li>
        </ul>
        
          <h1 class="entry-title">Zip 파일 반환하는 ActionResult 만들기</h1>
        
      </header>
      <footer class="entry-meta">
        
        
          <img src="http://blog.jakeymvc.com/images/jake-ryu-photo.jpg" class="bio-photo" alt="Jake Ryu bio photo"></a>
        
        <span class="author vcard">By <span class="fn">Jake Ryu</span></span>
        <span class="entry-date date published"><time datetime="2015-01-04T00:00:00+00:00"><i class="fa fa-calendar-o"></i> January 04, 2015</time></span>
        
        <span class="entry-comments"><i class="fa fa-comment-o"></i> <a href="#disqus_thread">Comment</a></span>
        <span class="social-share-twitter">
  <a href="https://twitter.com/intent/tweet?hashtags=mvc&amp;text=Zip%20파일%20반환하는%20ActionResult%20만들기&amp;url=http://blog.jakeymvc.com/action-result-to-return-zip-file/" title="Share on Twitter" itemprop="Twitter"><i class="fa fa-twitter-square"></i> Tweet</a>
</span>
<span class="social-share-facebook">
  <a href="https://www.facebook.com/sharer/sharer.php?u=http://blog.jakeymvc.com/action-result-to-return-zip-file/" title="Share on Facebook" itemprop="Facebook"><i class="fa fa-facebook-square"></i> Like</a>
</span>
<span class="social-share-googleplus">
  <a href="https://plus.google.com/share?url=http://blog.jakeymvc.com/action-result-to-return-zip-file/" title="Share on Google Plus" itemprop="GooglePlus"><i class="fa fa-google-plus-square"></i> +1</a>
</span>
<!-- /.social-share -->
        
      </footer>
      <div class="entry-content">
        <p>이미지 뷰어를 구현하다 다운로드 기능이 필요해졌다. 한 번 클릭에 뷰어에서 재생되는 모든 이미지를 압축하여 다운로드 한다. 아무래도 압축 풀기의 번거로움이 있으니 이미지가 하나만 있다면 압축 없이 다운로드할 수 있게 해보자.</p>

<h1 id="dotnetzip">DotNetZip</h1>

<p>압축 후 다운로드 (zip and download)를 구현하기 위해 다른 개발자들은 어떻게 하고 있는지 알아보자.</p>

<p><a href="https://www.nuget.org/packages/DotNetZip/">DotNetZip</a> 은 NuGet 패키지로서 2011년 2월부터 최근까지 꾸준히 업데이트 되었고 다른 패키지에 대한 의존성이 없다. 또한, 많은 개발자들이 다운로드한 것으로 보아 신뢰할 수 있겠고 <code class="highlighter-rouge">Microsoft Public License</code> 하에 기업에서도 사용하는데 문제가 없기 때문에 훌륭한 솔루션이다.</p>

<p>그럼에도 불구하고 패키지에 종속되지 않게 구현할 수 없을까 하여 조사해 보니, 닷넷 프레임워크 4.5에서 <code class="highlighter-rouge">ZipArchive</code>와 <code class="highlighter-rouge">ZipFile</code> 이라는 압축과  관련된 클래스가 추가된 것을 찾을 수 있었다. 이 클래스들을 사용하는 예제를 보니 <code class="highlighter-rouge">DotNetZip</code> 패키지를 사용하는 것 만큼이나 아주 간단하고 편리하게 압축 파일을 다룰 수 있다.</p>

<p>MVC 컨트롤러에는 파일을 반환하는 Action Result가 있으니 이를 참고하여 Zip 파일을 반환하는 Action Result를 만들어 보자.</p>

<h1 id="fileresult--">FileResult는 어떻게 구현되었나?</h1>

<p>MVC 프레임워크에서 액션 메서드는 <code class="highlighter-rouge">Response</code> 개체를 직접 다루지 않는다. 대신, <code class="highlighter-rouge">ActionResult</code> 클래스를 상속하는 개체를 반환하도록 설계되었는데 이 것은 목표를 결정하는 것과 목표를 실행하는 것을 분리하는 일종의 Command 패턴이다.</p>

<blockquote>
  <p>Command 패턴은 어떤 행동(명령)을 개체로 표현함으로써 명령을 실행하는 클라이언트와 명령 실행에 필요한 요소(데이터, 로직 등)를 분리한다. 모든 명령은 인터페이스를 상속하여 구현하므로 Logging, Validation, Undo 기능을 적용하기에 용이하다. 새로운 명령이 필요할 때, 기존 코드를 수정하지 않고 새 명령 클래스를 추가하기 때문에 Design Principal 중 하나인 Open for extension, but closed for modification 의 개념을 잘 따르고 있다. ActionResult가 추상클래스로서 ExecuteResult 메서드 하나만을 갖고 있고 MVC 프레임워크(클라이언트)에 의해 호출되어 실행된다는 것이 Command 패턴에서 Command가 갖는 개념과 일치한다.</p>
</blockquote>

<p>MVC 프레임워크는 액션 메서드로부터 <code class="highlighter-rouge">ActionResult</code> 객체를 받는 경우, 그 객체에 정의되어 있는 <code class="highlighter-rouge">ExecuteResult</code> 메서드를 호출하고, 이 메서드는 실행 결과를 Response의 출력 스트림에 반영한다. 이해를 돕기 위해 <code class="highlighter-rouge">ActionResult</code> 중 한 가지인 파일을 반환하는 방법에 대해 상세히 알아보자.</p>

<p>MVC 컨트롤러는 파일을 반환하는 6개의 오버로드 메서드를 제공한다. (<a href="https://msdn.microsoft.com/en-us/library/system.web.mvc.controller.file(v=vs.118).aspx">MSDN 참조 - Controller.File Method</a>)</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="k">protected</span> <span class="k">internal</span> <span class="n">FileContentResult</span> <span class="nf">File</span><span class="p">(</span><span class="kt">byte</span><span class="p">[]</span> <span class="n">fileContents</span><span class="p">,</span> <span class="kt">string</span> <span class="n">contentType</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="nf">File</span><span class="p">(</span><span class="n">fileContents</span><span class="p">,</span> <span class="n">contentType</span><span class="p">,</span> <span class="k">null</span> <span class="cm">/* fileDownloadName */</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">protected</span> <span class="k">internal</span> <span class="k">virtual</span> <span class="n">FileContentResult</span> <span class="nf">File</span><span class="p">(</span><span class="kt">byte</span><span class="p">[]</span> <span class="n">fileContents</span><span class="p">,</span> <span class="kt">string</span> <span class="n">contentType</span><span class="p">,</span> <span class="kt">string</span> <span class="n">fileDownloadName</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nf">FileContentResult</span><span class="p">(</span><span class="n">fileContents</span><span class="p">,</span> <span class="n">contentType</span><span class="p">)</span> <span class="p">{</span> <span class="n">FileDownloadName</span> <span class="p">=</span> <span class="n">fileDownloadName</span> <span class="p">};</span>
<span class="p">}</span>
<span class="k">protected</span> <span class="k">internal</span> <span class="n">FileStreamResult</span> <span class="nf">File</span><span class="p">(</span><span class="n">Stream</span> <span class="n">fileStream</span><span class="p">,</span> <span class="kt">string</span> <span class="n">contentType</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="nf">File</span><span class="p">(</span><span class="n">fileStream</span><span class="p">,</span> <span class="n">contentType</span><span class="p">,</span> <span class="k">null</span> <span class="cm">/* fileDownloadName */</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">protected</span> <span class="k">internal</span> <span class="k">virtual</span> <span class="n">FileStreamResult</span> <span class="nf">File</span><span class="p">(</span><span class="n">Stream</span> <span class="n">fileStream</span><span class="p">,</span> <span class="kt">string</span> <span class="n">contentType</span><span class="p">,</span> <span class="kt">string</span> <span class="n">fileDownloadName</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nf">FileStreamResult</span><span class="p">(</span><span class="n">fileStream</span><span class="p">,</span> <span class="n">contentType</span><span class="p">)</span> <span class="p">{</span> <span class="n">FileDownloadName</span> <span class="p">=</span> <span class="n">fileDownloadName</span> <span class="p">};</span>
<span class="p">}</span>
<span class="k">protected</span> <span class="k">internal</span> <span class="n">FilePathResult</span> <span class="nf">File</span><span class="p">(</span><span class="kt">string</span> <span class="n">fileName</span><span class="p">,</span> <span class="kt">string</span> <span class="n">contentType</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="nf">File</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span> <span class="n">contentType</span><span class="p">,</span> <span class="k">null</span> <span class="cm">/* fileDownloadName */</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">protected</span> <span class="k">internal</span> <span class="k">virtual</span> <span class="n">FilePathResult</span> <span class="nf">File</span><span class="p">(</span><span class="kt">string</span> <span class="n">fileName</span><span class="p">,</span> <span class="kt">string</span> <span class="n">contentType</span><span class="p">,</span> <span class="kt">string</span> <span class="n">fileDownloadName</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nf">FilePathResult</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span> <span class="n">contentType</span><span class="p">)</span> <span class="p">{</span> <span class="n">FileDownloadName</span> <span class="p">=</span> <span class="n">fileDownloadName</span> <span class="p">};</span>
<span class="p">}</span></code></pre></figure>

<p>이들 메서드는 파일을 만들거나 읽을 때, 편의를 위해 세 가지 다른 종류의 개체(<code class="highlighter-rouge">FilePathResult</code>, <code class="highlighter-rouge">FileStreamResult</code>, <code class="highlighter-rouge">FileContentResult</code>)를 사용한다. 그 이름에서 짐작할 수 있듯이 파일의 위치, 파일 스트림, 바이트 배열을 다루면서 궁극적으로 <code class="highlighter-rouge">Resopnse</code>의 출력 스트림에 그 내용을 작성한다. 이렇게 다른 소스를 다루어야 하기 때문에 FileResult 라는 추상 클래스에 <code class="highlighter-rouge">WriteFile</code> 라는 추상 메서드를 정의하여 자식 클래스에서 <code class="highlighter-rouge">WriteFile</code> 메서드를 구현하도록 한다. 클래스 간의 관계는 아래 클래스 다이어그램으로 쉽게 이해할 수 있다.</p>

<p><img src="/images/post/file-result-class.png" alt="FileResult 클래스의 상속관계" /></p>

<p>[그림-1] FileResult 클래스의 상속관계</p>

<p>ASP.NET MVC 는 오픈 소스인 덕에 FileResult 클래스가 어떻게 구현되었는지 알아볼 수 있다.</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="k">public</span> <span class="k">abstract</span> <span class="k">class</span> <span class="nc">FileResult</span> <span class="p">:</span> <span class="n">ActionResult</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="kt">string</span> <span class="n">_fileDownloadName</span><span class="p">;</span>
    <span class="k">protected</span> <span class="nf">FileResult</span><span class="p">(</span><span class="kt">string</span> <span class="n">contentType</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">String</span><span class="p">.</span><span class="nf">IsNullOrEmpty</span><span class="p">(</span><span class="n">contentType</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentException</span><span class="p">(</span><span class="n">MvcResources</span><span class="p">.</span><span class="n">Common_NullOrEmpty</span><span class="p">,</span> <span class="s">"contentType"</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">ContentType</span> <span class="p">=</span> <span class="n">contentType</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">ContentType</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">FileDownloadName</span>
    <span class="p">{</span>
        <span class="k">get</span> <span class="p">{</span> <span class="k">return</span> <span class="n">_fileDownloadName</span> <span class="p">??</span> <span class="n">String</span><span class="p">.</span><span class="n">Empty</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">set</span> <span class="p">{</span> <span class="n">_fileDownloadName</span> <span class="p">=</span> <span class="k">value</span><span class="p">;</span> <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">public</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">ExecuteResult</span><span class="p">(</span><span class="n">ControllerContext</span> <span class="n">context</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">context</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentNullException</span><span class="p">(</span><span class="s">"context"</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">HttpResponseBase</span> <span class="n">response</span> <span class="p">=</span> <span class="n">context</span><span class="p">.</span><span class="n">HttpContext</span><span class="p">.</span><span class="n">Response</span><span class="p">;</span>
        <span class="n">response</span><span class="p">.</span><span class="n">ContentType</span> <span class="p">=</span> <span class="n">ContentType</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(!</span><span class="n">String</span><span class="p">.</span><span class="nf">IsNullOrEmpty</span><span class="p">(</span><span class="n">FileDownloadName</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="c1">// From RFC 2183, Sec. 2.3:
</span>            <span class="c1">// The sender may want to suggest a filename to be used if the entity is
</span>            <span class="c1">// detached and stored in a separate file. If the receiving MUA writes
</span>            <span class="c1">// the entity to a file, the suggested filename should be used as a
</span>            <span class="c1">// basis for the actual filename, where possible.
</span>            <span class="kt">string</span> <span class="n">headerValue</span> <span class="p">=</span> <span class="n">ContentDispositionUtil</span><span class="p">.</span><span class="nf">GetHeaderValue</span><span class="p">(</span><span class="n">FileDownloadName</span><span class="p">);</span>
            <span class="n">context</span><span class="p">.</span><span class="n">HttpContext</span><span class="p">.</span><span class="n">Response</span><span class="p">.</span><span class="nf">AddHeader</span><span class="p">(</span><span class="s">"Content-Disposition"</span><span class="p">,</span> <span class="n">headerValue</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nf">WriteFile</span><span class="p">(</span><span class="n">response</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">protected</span> <span class="k">abstract</span> <span class="k">void</span> <span class="nf">WriteFile</span><span class="p">(</span><span class="n">HttpResponseBase</span> <span class="n">response</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<p><code class="highlighter-rouge">content type</code> 은 파일의 정체성을 결정하는 중요 요소이므로 생성자에서 반드시 필요하다. <code class="highlighter-rouge">ExecuteResult</code> 메서드에서는 <code class="highlighter-rouge">Response</code> 개체에 접근하기 위해 컨트롤러 컨텍스트의 유효성 여부를 먼저 확인한 후, 파일이 다운로드될 수 있도록 <code class="highlighter-rouge">Response</code> 의 헤더를 조정한다. 참고로 <code class="highlighter-rouge">ContentDispositionUtil.GetHeaderValue</code> 메서드는 닷넷 프레임워크 4.0에서 파일명에 유니코드가 포함되었을 때 발생하는 <code class="highlighter-rouge">Content-Disposition</code> 헤더 작성 문제를 보완하기 위해 사용하고 있다.</p>

<p>이후 작성할 <code class="highlighter-rouge">ZipResult</code> 라는 사용자 정의 액션결과에서는 응답 헤더에 아래 내용을 추가할 것이다.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>Content-Type: application/zip
content-disposition: attachment; filename=SampleFiles.zip
</code></pre>
</div>

<p><code class="highlighter-rouge">ExecuteResult</code> 메서드는 프로세스의 마지막에 <code class="highlighter-rouge">WirteFile</code> 메서드에 <code class="highlighter-rouge">Response</code> 객체를 전달하는 것으로 종료되었다. 이 메서드는 추상 메서드로 정의되었기 때문에, 최종 처리는 자식 클래스 - <code class="highlighter-rouge">FilePathResult</code>, <code class="highlighter-rouge">FileStreamResult</code>, <code class="highlighter-rouge">FileContentResult</code> - 의 <code class="highlighter-rouge">WriteFile</code> 메서드에 의존하고 있는 것이다. 자식 클래스에서 <code class="highlighter-rouge">WriteFile</code> 메서드를 어떻게 구현했는지 살펴보자.</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="c1">// FilePathResult
</span><span class="k">protected</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">WriteFile</span><span class="p">(</span><span class="n">HttpResponseBase</span> <span class="n">response</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">response</span><span class="p">.</span><span class="nf">TransmitFile</span><span class="p">(</span><span class="n">FileName</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="c1">// FileStreamResult
</span><span class="k">protected</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">WriteFile</span><span class="p">(</span><span class="n">HttpResponseBase</span> <span class="n">response</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// grab chunks of data and write to the output stream
</span>    <span class="n">Stream</span> <span class="n">outputStream</span> <span class="p">=</span> <span class="n">response</span><span class="p">.</span><span class="n">OutputStream</span><span class="p">;</span>
    <span class="k">using</span> <span class="p">(</span><span class="n">FileStream</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">byte</span><span class="p">[]</span> <span class="n">buffer</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="p">[</span><span class="n">BufferSize</span><span class="p">];</span>
        <span class="k">while</span> <span class="p">(</span><span class="k">true</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">int</span> <span class="n">bytesRead</span> <span class="p">=</span> <span class="n">FileStream</span><span class="p">.</span><span class="nf">Read</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">BufferSize</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">bytesRead</span> <span class="p">==</span> <span class="m">0</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="c1">// no more data
</span>                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">outputStream</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">bytesRead</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="c1">// FileContentResult
</span><span class="k">protected</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">WriteFile</span><span class="p">(</span><span class="n">HttpResponseBase</span> <span class="n">response</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">response</span><span class="p">.</span><span class="n">OutputStream</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="n">FileContents</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">FileContents</span><span class="p">.</span><span class="n">Length</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<p>파일명을 사용하는 경우에는 ‘Response’ 개체가 제공하는 메서드를 통해 파일을 처리하지만, 파일 스트림과 바이트 배열을 다룰 때는 ‘Response’의 출력 스트림에 그 내용을 직접 쓰고 있다.</p>

<p><code class="highlighter-rouge">ActionResult</code> - <code class="highlighter-rouge">FileResult</code> - <code class="highlighter-rouge">FileResult의 자식 클래스</code>들까지 예상보다 복잡한 단계를 살펴봐야 했지만, 액션 메서드에서 File 관련 메서드를 사용할 때, MVC 프레임워크에서 어떻게 처리하는지 구체적으로 알게 되었다.</p>

<h1 id="actionresult">사용자 정의 ActionResult</h1>

<p>이제 <code class="highlighter-rouge">FileResult</code>의 동작 원리를 이해했으니 <code class="highlighter-rouge">Zip</code> 파일을 반환하는 <code class="highlighter-rouge">ActionResult</code>를 만들어 보자. 이것은 MVC 프레임워크의 일부처럼 동작할 것이기에 프로젝트 루트 아래 <code class="highlighter-rouge">Infrastructure</code> 라는 폴더를 만들고 <code class="highlighter-rouge">ZipResult</code> 라는 클래스를 준비하여 아래 코드와 같이 편집하자.</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span class="k">public</span> <span class="k">class</span> <span class="nc">ZipResult</span> <span class="p">:</span> <span class="n">ActionResult</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="kt">string</span> <span class="n">zipFileName</span><span class="p">;</span>
    <span class="k">private</span> <span class="n">List</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="n">filesToZip</span><span class="p">;</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">ZipFileName</span> <span class="p">{</span> 
        <span class="k">get</span> <span class="p">{</span> <span class="k">return</span> <span class="n">zipFileName</span> <span class="p">??</span> <span class="s">"unnamed.zip"</span><span class="p">;}</span> 
        <span class="k">set</span> <span class="p">{</span><span class="n">zipFileName</span> <span class="p">=</span> <span class="k">value</span><span class="p">;}</span>
    <span class="p">}</span>
    <span class="k">public</span> <span class="nf">ZipResult</span><span class="p">(</span><span class="kt">string</span> <span class="n">zipFileName</span><span class="p">,</span> <span class="n">List</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="n">filesToZip</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">filesToZip</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentException</span><span class="p">(</span><span class="s">"No file is specified to compress and download."</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">this</span><span class="p">.</span><span class="n">filesToZip</span> <span class="p">=</span> <span class="n">filesToZip</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(!</span><span class="kt">string</span><span class="p">.</span><span class="nf">IsNullOrEmpty</span><span class="p">(</span><span class="n">zipFileName</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="n">zipFileName</span> <span class="p">=</span> <span class="n">zipFileName</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">public</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">ExecuteResult</span><span class="p">(</span><span class="n">ControllerContext</span> <span class="n">context</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">using</span> <span class="p">(</span><span class="n">MemoryStream</span> <span class="n">ms</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">MemoryStream</span><span class="p">())</span>
        <span class="p">{</span>
            <span class="k">using</span> <span class="p">(</span><span class="n">ZipArchive</span> <span class="n">fileContainer</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">ZipArchive</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">ZipArchiveMode</span><span class="p">.</span><span class="n">Create</span><span class="p">,</span> <span class="k">true</span><span class="p">))</span>
            <span class="p">{</span>
                <span class="k">foreach</span> <span class="p">(</span><span class="kt">string</span> <span class="n">filePath</span> <span class="k">in</span> <span class="n">filesToZip</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">File</span><span class="p">.</span><span class="nf">Exists</span><span class="p">(</span><span class="n">filePath</span><span class="p">))</span>
                    <span class="p">{</span>
                        <span class="n">fileContainer</span><span class="p">.</span><span class="nf">CreateEntryFromFile</span><span class="p">(</span><span class="n">filePath</span><span class="p">,</span> <span class="n">Path</span><span class="p">.</span><span class="nf">GetFileName</span><span class="p">(</span><span class="n">filePath</span><span class="p">));</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>  <span class="c1">// ZipArchive object is disposed and automatically backed in the memory stream
</span>            <span class="kt">var</span> <span class="n">response</span> <span class="p">=</span> <span class="n">context</span><span class="p">.</span><span class="n">HttpContext</span><span class="p">.</span><span class="n">Response</span><span class="p">;</span>
            <span class="n">response</span><span class="p">.</span><span class="n">ContentType</span> <span class="p">=</span> <span class="s">"application/zip"</span><span class="p">;</span>
            <span class="n">response</span><span class="p">.</span><span class="nf">AppendHeader</span><span class="p">(</span><span class="s">"content-disposition"</span><span class="p">,</span> <span class="s">"attachment; filename="</span> <span class="p">+</span> <span class="n">ZipFileName</span><span class="p">);</span>
            <span class="n">ms</span><span class="p">.</span><span class="nf">WriteTo</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">OutputStream</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>액션 메서드에서 반환할 수 있는 <code class="highlighter-rouge">ActionResult</code>가 되기 위해 <code class="highlighter-rouge">ZipResult</code> 클래스는 <code class="highlighter-rouge">ActionResult</code> 클래스를 상속하고 <code class="highlighter-rouge">ExecuteResult</code> 메서드를 재정의한다. 이 메서드의 마지막 과정을 먼저 보자면, <code class="highlighter-rouge">FileResult</code>의 자식 클래스들에서 본 것과 같이 <code class="highlighter-rouge">Response</code> 헤더에 zip 파일이라는 컨텐트 형식과 원하는 파일명을 명시하고, 압축 파일 자체를 <code class="highlighter-rouge">Response</code> 의 출력 스트림에 복사하고 있다.</p>

<p><code class="highlighter-rouge">FileResult</code>의 <code class="highlighter-rouge">ExecuteResult</code>에서는 <code class="highlighter-rouge">WriteFile</code> 메서드를 한번 더 호출해서 다른 파일 소스(파일 경로, 파일 스트림, 바이트 배열)에 따라 다르게 동작하도록 다형성을 구현하였으나, <code class="highlighter-rouge">ZipResult</code> 액션 결과는 간단히 메모리 스트림만을 사용하기에 응답 처리까지 포함시키도록 구현했다. 만약, 다른 종류의 동작이 필요하다면 <code class="highlighter-rouge">FileResult</code> 클래스처럼 추상 클래스로 만들어 자식 클래스에 로직 구현을 위임하면 된다.</p>

<h1 id="section">압축 구현하기</h1>

<p>다시 코드로 돌아가서 압축과 관련된 내용을 살펴보자. 닷넷 프레임워크에서 압축 관련 클래스는 <code class="highlighter-rouge">System.IO.Compression</code> 네임스페이스에 있는데, 이 네임스페이스는 세 개의 어셈블리에 구현되어 있다. 여기서는 <code class="highlighter-rouge">System.IO.Compression.dll</code> 과 <code class="highlighter-rouge">System.IO.Compression.FileSystem.dll</code> 이라는 두 가지 어셈블리에 대한 참조를 추가해야 한다.</p>

<p><img src="/images/post/compression-references.png" alt="닷넷 어셈블리 참조" /></p>

<p>[그림-2]  닷넷 어셈블리 참조</p>

<p><code class="highlighter-rouge">ZipResult</code> 클래스의 <code class="highlighter-rouge">ExecuteResult</code> 메서드에서 구현할 핵심 사항은 여러 개의 파일을 하나의 zip 파일로 생성하는 것이다. 그러기 위해 압축에 포함될 대상 파일들과 최종 zip 파일의 이름 정도를 알아야 한다. 위의 소스 코드를 보면, 생성자에 정의한 두 개의 매개변수가 그 것이다. 이렇게 전달 받은 정보는 <code class="highlighter-rouge">ExecuteResult</code> 메서드에서 사용된다.</p>

<p><code class="highlighter-rouge">ExecuteResult</code> 메서드를 구현하면서 zip 파일을 서버에 남기지 않기 위해 메모리 스트림을 사용했다. 이 메모리 스트림은 <code class="highlighter-rouge">ZipArchive</code> 객체를 생성할 때 전달되고, <code class="highlighter-rouge">ZipArchive</code> 객체가 소멸된 후에도 남아 있어 <code class="highlighter-rouge">Response.OuputStream</code>에 그 결과를 복사한다. 이를 위해, <code class="highlighter-rouge">ZipArchive</code> 생성자의 세 번째 매개변수를 <code class="highlighter-rouge">true</code>로 지정하여 <code class="highlighter-rouge">ZipArchive</code> 객체가 소멸되어도 스트림 객체를 <code class="highlighter-rouge">open</code> 상태로 남겨 두도록 설정했다. <code class="highlighter-rouge">ZipArchive</code> 객체를 정의한 <code class="highlighter-rouge">using</code>문의 끝에서 <code class="highlighter-rouge">ZipArchive</code>가 소멸되면서 <code class="highlighter-rouge">Dispose</code> 메서드가 호출되고 <code class="highlighter-rouge">ZipArchive</code> 객체의 내용은 자동으로 <code class="highlighter-rouge">backing store stream</code>인 메모리 스트림에 저장된다.</p>

<p>마지막으로 메모리 스트림의 내용을 <code class="highlighter-rouge">Response</code>의 출력 스트림에 복사하여 최종 압축 파일을 다운로드 시킨다.</p>

<h1 id="section-1">컨트롤러에서 사용하기</h1>

<p>컨트롤러에서는 <code class="highlighter-rouge">ZipResult</code> 객체의 생성에 필요한 압축대상 파일 리스트를 조회한다. <code class="highlighter-rouge">ZipResult</code> 객체를 반환하면 MVC 프레임워크에서는 <code class="highlighter-rouge">ExecuteResult</code> 메서드를 호출하여 최종 응답을 생성한다.</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"> <span class="k">public</span> <span class="n">ActionResult</span> <span class="nf">Download</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">fileStorage</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">FileStorage</span><span class="p">();</span>
    <span class="n">List</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="n">filePaths</span> <span class="p">=</span> <span class="n">fileStorage</span><span class="p">.</span><span class="nf">GetFiles</span><span class="p">();</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nf">ZipResult</span><span class="p">(</span><span class="s">"SampleFiles.zip"</span><span class="p">,</span> <span class="n">filePaths</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<h1 id="section-2">정리</h1>

<p>이미지를 네비게이트할 수 있는 뷰어 페이지에 <code class="highlighter-rouge">Zip and download</code> 기능을 추가한다는 간단한 요구사항에서 출발했다. 닷넷 프레임워크의 <code class="highlighter-rouge">BCL(Base Class Library)</code>을 활용한 압축 방법과 사용자 정의 <code class="highlighter-rouge">ActionResult</code>를 어떻게 작성하는지 살펴 보았다. 오픈 소스인 ASP.NET MVC 의 <code class="highlighter-rouge">FileResult</code> 구현을 보면서 <code class="highlighter-rouge">ActionResult</code>가 Command 패턴으로 구현된 것을 확인할 수 있었다.</p>

<p>전체소스는 <a href="https://github.com/JakeRyu/BlogSamples/tree/master/ZipAndDownload">GitHub</a>에서 찾아볼 수 있다.</p>


        
          <div id="disqus_thread"></div><!-- /#disqus_thread -->
          
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'jakeymvcblog'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'https://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

        
      </div><!-- /.entry-content -->
    </div><!-- /.entry-wrapper -->
    <nav class="pagination" role="navigation">
      
        <a href="http://blog.jakeymvc.com/five-reasons-to-use-mvc/" class="btn" title="ASP.NET MVC를 사용해야 하는 다섯가지 이유">Previous</a>
      
      
        <a href="http://blog.jakeymvc.com/sso-approach/" class="btn" title="간단한 SSO #1 - 접근법">Next</a>
      
    </nav><!-- /.pagination -->
  </article>
</div><!-- /#main -->



<div class="footer-wrapper">
  <footer role="contentinfo" class="entry-wrapper">
    

<span>&copy; 2016 Jake Ryu. Powered by <a href="http://jekyllrb.com" rel="nofollow">Jekyll</a> using the <a href="https://mademistakes.com/work/so-simple-jekyll-theme/" rel="nofollow">So Simple Theme</a>.</span>
<div class="social-icons">
	
	<a href="https://facebook.com/ryu.jihyung" title="Jake Ryu on Facebook" target="_blank"><i class="fa fa-facebook-square fa-2x"></i></a>
	
	
	
	
	
	<a href="https://github.com/jakeymvc" title="Jake Ryu on Github" target="_blank"><i class="fa fa-github-square fa-2x"></i></a>
	
  
	
  <a href="http://blog.jakeymvc.com/feed.xml" title="Atom/RSS feed"><i class="fa fa-rss-square fa-2x"></i></a>
</div><!-- /.social-icons -->

  </footer>
</div><!-- /.footer-wrapper -->

<script type="text/javascript">
  var BASE_URL = 'http://blog.jakeymvc.com';
</script>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="http://blog.jakeymvc.com/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script src="http://blog.jakeymvc.com/assets/js/scripts.min.js"></script>


<!-- Asynchronous Google Analytics snippet 
<script>
  var _gaq = _gaq || [];
  var pluginUrl =
 'https://www.google-analytics.com/plugins/ga/inpage_linkid.js';
  _gaq.push(['_require', 'inpage_linkid', pluginUrl]);
  _gaq.push(['_setAccount', 'UA-54850641-2']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = 'https://stats.g.doubleclick.net/dc.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>
-->

  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-54850641-2', 'auto');
  ga('send', 'pageview');

  </script>





</body>
</html>
